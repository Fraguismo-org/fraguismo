{% extends 'base.html' %}

{% block content %}
{% load static %}
{% load humanize %}
<div class="shadow p-4 mb-5 bg-body rounded">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3">
        <div>
            <p class="text-uppercase text-muted fw-semibold small mb-1">Marketplace</p>
            <h2 class="h4 mb-0">Meus anúncios</h2>
        </div>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" href="{% url 'home' %}">
                <i class="bi bi-shop"></i> Ver marketplace
            </a>
            <a class="btn btn-primary" href="{% url 'cadastrar_anuncio' %}">
                <i class="bi bi-plus-lg"></i> Novo anúncio
            </a>
        </div>
    </div>

    <form method="get" class="row g-2 align-items-center mb-3">
        <div class="col-12 col-md-6">
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input
                    type="text"
                    name="busca"
                    value="{{ busca }}"
                    class="form-control"
                    placeholder="Buscar por título, código, descrição ou localidade">
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2">
            <select name="status" class="form-select">
                <option value="">Status (todos)</option>
                {% for value, label in status_choices %}
                <option value="{{ value }}" {% if status == value|stringformat:'s' %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-6 col-md-3 col-lg-2">
            <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-funnel"></i> Filtrar
            </button>
        </div>
    </form>

    {% if anuncios and anuncios|length > 0 %}
        <div class="list-group mb-3">
            {% for anuncio in anuncios %}
            <div class="list-group-item py-3">
                <div class="row g-3 align-items-center">
                    <div class="col-auto">
                        <div class="ratio ratio-1x1" style="width: 90px;">
                            {% with imagem=anuncio.imagens.first %}
                            <img
                                src="{% if imagem %}{{ imagem.image.url }}{% else %}{% static 'images/default-fraguinha.png' %}{% endif %}"
                                class="img-fluid rounded" alt="Imagem do anúncio">
                            {% endwith %}
                        </div>
                    </div>
                    <div class="col">
                        <div class="d-flex flex-wrap align-items-center gap-2 mb-1">
                            <span class="text-muted small">{{ anuncio.cod_anuncio }}</span>
                            {% if anuncio.status_anuncio == 1 %}
                            <span class="badge text-bg-success">Ativo</span>
                            {% elif anuncio.status_anuncio == 2 %}
                            <span class="badge text-bg-secondary">Encerrado</span>
                            {% else %}
                            <span class="badge text-bg-warning text-dark">Pausado</span>
                            {% endif %}
                        </div>
                        <h5 class="mb-1">{{ anuncio.titulo }}</h5>
                        <p class="mb-1 text-muted small">
                            {{ anuncio.descricao|slice:":120" }}{% if anuncio.descricao|length > 120 %}...{% endif %}
                        </p>
                        <div class="d-flex flex-wrap gap-3 text-muted small">
                            <span><i class="bi bi-geo-alt-fill"></i> {{ anuncio.localidade|default:"N&atilde;o informado" }}</span>
                            <span><i class="bi bi-clock-history"></i> Atualizado em {{ anuncio.updated_at|date:"d/m/Y H:i" }}</span>
                        </div>
                    </div>
                    <div class="col-12 col-lg-auto text-lg-end">
                        <div class="h5 mb-2">R${{ anuncio.preco|floatformat:2 }}</div>
                        <div class="d-flex flex-wrap gap-2 justify-content-lg-end">
                            <a class="btn btn-sm btn-outline-secondary" href="{% url 'page_anuncio' cod_anuncio=anuncio.cod_anuncio %}">
                                <i class="bi bi-eye"></i> Ver
                            </a>
                            <a class="btn btn-sm btn-outline-primary" href="{% url 'editar_anuncio' id=anuncio.id %}">
                                <i class="bi bi-pencil-fill"></i> Editar
                            </a>
                            <a class="btn btn-sm btn-outline-danger" href="{% url 'deletar_anuncio' id=anuncio.id %}">
                                <i class="bi bi-trash-fill"></i> Excluir
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        {% if anuncios.paginator.num_pages > 1 %}
        <nav aria-label="Paginação" class="d-flex justify-content-center">
            <ul class="pagination">
                {% if anuncios.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ anuncios.previous_page_number }}&busca={{ busca }}&status={{ status }}">&laquo;</a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                {% endif %}

                {% for num in anuncios.paginator.page_range %}
                <li class="page-item {% if anuncios.number == num %}active{% endif %}">
                    <a class="page-link" href="?page={{ num }}&busca={{ busca }}&status={{ status }}">{{ num }}</a>
                </li>
                {% endfor %}

                {% if anuncios.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ anuncios.next_page_number }}&busca={{ busca }}&status={{ status }}">&raquo;</a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    {% else %}
        <div class="text-center py-4">
            <p class="mb-3">Você ainda não tem anúncios.</p>
            <a class="btn btn-primary" href="{% url 'cadastrar_anuncio' %}">Criar meu primeiro anúncio</a>
        </div>
    {% endif %}
</div>
{% endblock %}
